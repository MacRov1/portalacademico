            <!DOCTYPE html>
            <html lang="es">
            <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title><%= isEdit ? 'Editar Materia' : 'Crear Materia' %></title>
              <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
            </head>
            <body class="bg-gradient-to-br from-slate-50 via-white to-blue-50 min-h-screen flex flex-col font-sans">

              <!-- Navbar -->
              <nav class="bg-white/80 backdrop-blur-md shadow-md sticky top-0 z-10">
                <div class="max-w-5xl mx-auto px-6 py-4 flex items-center justify-between">
                  <h1 class="text-2xl font-bold text-blue-700"><%= isEdit ? 'Editar Materia' : 'Crear Materia' %></h1>
                  <a href="/subjects/list" 
                     class="flex items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                    </svg>
                    Volver
                  </a>
                </div>
              </nav>

              <!-- Contenido -->
              <main class="flex-grow flex items-center justify-center px-4 py-10">
                <div class="bg-white shadow-xl rounded-2xl p-8 w-full max-w-2xl">

                  <h2 class="text-3xl font-extrabold mb-6 text-gray-800 text-center">
                    <%= isEdit ? 'Editar Materia' : 'Crear Materia' %>
                  </h2>

                  <% if (error) { %>
                    <p class="text-red-500 mb-6 font-semibold text-center bg-red-50 border border-red-200 rounded-lg py-2">
                      <%= error %>
                    </p>
                  <% } %>

                  <form action="<%= isEdit ? '/subjects/edit/' + subject._id : '/subjects/create' %>" 
                        method="POST" 
                        onsubmit="return validateSchedules(event)"
                        class="space-y-6">

                    <!-- Código -->
                    <div>
                      <label for="code" class="block text-sm font-medium text-gray-700">Código</label>
                      <input type="text" name="code" id="code"
                             value="<%= isEdit && subject ? subject.code : '' %>"
                             class="mt-1 p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" required>
                    </div>

                    <!-- Nombre -->
                    <div>
                      <label for="name" class="block text-sm font-medium text-gray-700">Nombre</label>
                      <input type="text" name="name" id="name"
                             value="<%= isEdit && subject ? subject.name : '' %>"
                             class="mt-1 p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" required>
                    </div>

                    <!-- Créditos y Semestre en grid -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                      <div>
                        <label for="credits" class="block text-sm font-medium text-gray-700">Créditos</label>
                        <input type="number" name="credits" id="credits"
                               value="<%= isEdit && subject ? subject.credits : '' %>"
                               class="mt-1 p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" min="0" required>
                      </div>

                      <div>
                        <label for="semester" class="block text-sm font-medium text-gray-700">Semestre</label>
                        <input type="number" name="semester" id="semester"
                               value="<%= isEdit && subject ? subject.semester : '' %>"
                               class="mt-1 p-3 w-full border rounded-lg focus:ring-2 focus:ring-blue-400 focus:outline-none" min="1" required>
                      </div>
                    </div>

                    <!-- Horarios -->
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Horarios (opcional)</label>
                      <div id="schedule-container" class="space-y-2">
                        <% if (isEdit && subject && subject.schedule && subject.schedule.length > 0) { %>
                          <% subject.schedule.forEach((slot) => { %>
                            <div class="schedule-slot flex space-x-2">
                              <select name="scheduleDays[]" class="p-2 border rounded-lg">
                                <option value="Lunes" <%= slot.day==='Lunes'?'selected':'' %>>Lunes</option>
                                <option value="Martes" <%= slot.day==='Martes'?'selected':'' %>>Martes</option>
                                <option value="Miércoles" <%= slot.day==='Miércoles'?'selected':'' %>>Miércoles</option>
                                <option value="Jueves" <%= slot.day==='Jueves'?'selected':'' %>>Jueves</option>
                                <option value="Viernes" <%= slot.day==='Viernes'?'selected':'' %>>Viernes</option>
                              </select>
                              <input type="text" name="scheduleTimes[]" value="<%= slot.time %>"
                                     class="p-2 border rounded-lg flex-1"
                                     placeholder="Ej: 08:00-12:00"
                                     pattern="^([0-1][0-9]|2[0-3]|00):[0-5][0-9]-([0-1][0-9]|2[0-3]|00):[0-5][0-9]$"
                                     title="Formato HH:MM-HH:MM (00:00-23:59)" required>
                              <button type="button" class="remove-schedule bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">
                                ✕
                              </button>
                            </div>
                          <% }) %>
                        <% } else { %>
                          <div class="schedule-slot flex space-x-2">
                            <select name="scheduleDays[]" class="p-2 border rounded-lg">
                              <option value="Lunes">Lunes</option>
                              <option value="Martes">Martes</option>
                              <option value="Miércoles">Miércoles</option>
                              <option value="Jueves">Jueves</option>
                              <option value="Viernes">Viernes</option>
                            </select>
                            <input type="text" name="scheduleTimes[]"
                                   class="p-2 border rounded-lg flex-1"
                                   placeholder="Ej: 08:00-12:00"
                                   pattern="^([0-1][0-9]|2[0-3]|00):[0-5][0-9]-([0-1][0-9]|2[0-3]|00):[0-5][0-9]$"
                                   title="Formato HH:MM-HH:MM (00:00-23:59)" required>
                            <button type="button" class="remove-schedule bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">
                              ✕
                            </button>
                          </div>
                        <% } %>
                      </div>
                      <button type="button" id="add-schedule"
                              class="mt-3 w-full flex justify-center items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Añadir Horario
                      </button>
                    </div>

                    <!-- Previas -->
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Previas (opcional)</label>
                      <div id="prerequisites-container" class="space-y-2">
                        <% if (isEdit && subject && subject.prerequisites && subject.prerequisites.length > 0) { %>
                          <% subject.prerequisites.forEach((prereq) => { %>
                            <div class="prerequisite-slot flex space-x-2">
                              <select name="prerequisites[]" class="p-2 border rounded-lg flex-1">
                                <option value="">Seleccione una materia</option>
                                <% if (subjects) { %>
                                  <% subjects.forEach(s => { %>
                                    <option value="<%= s._id %>" <%= prereq.subjectId && prereq.subjectId._id.toString()===s._id.toString()?'selected':'' %>><%= s.name %></option>
                                  <% }) %>
                                <% } %>
                              </select>
                              <select name="prerequisiteTypes[]" class="p-2 border rounded-lg">
                                <option value="exam" <%= prereq.type==='exam'?'selected':'' %>>Examen</option>
                                <option value="course" <%= prereq.type==='course'?'selected':'' %>>Curso</option>
                              </select>
                              <button type="button" class="remove-prerequisite bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">✕</button>
                            </div>
                          <% }) %>
                        <% } else { %>
                          <div class="prerequisite-slot flex space-x-2">
                            <select name="prerequisites[]" class="p-2 border rounded-lg flex-1">
                              <option value="">Seleccione una materia</option>
                              <% if (subjects) { %>
                                <% subjects.forEach(s => { %>
                                  <option value="<%= s._id %>"><%= s.name %></option>
                                <% }) %>
                              <% } %>
                            </select>
                            <select name="prerequisiteTypes[]" class="p-2 border rounded-lg">
                              <option value="exam">Examen</option>
                              <option value="course">Curso</option>
                            </select>
                            <button type="button" class="remove-prerequisite bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">✕</button>
                          </div>
                        <% } %>
                      </div>
                      <button type="button" id="add-prerequisite"
                              class="mt-3 w-full flex justify-center items-center gap-2 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-md hover:bg-blue-600 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Añadir Previa
                      </button>
                    </div>

                    <!-- Botón submit -->
                    <button type="submit"
                            class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold shadow-md hover:bg-blue-700 transform hover:-translate-y-0.5 transition duration-300">
                      <%= isEdit ? 'Actualizar Materia' : 'Crear Materia' %>
                    </button>
                  </form>
                </div>
              </main>

              <!-- Scripts -->
              <script>
                // Añadir horario
                document.getElementById('add-schedule').addEventListener('click', function() {
                  const container = document.getElementById('schedule-container');
                  const slot = document.createElement('div');
                  slot.className = 'schedule-slot flex space-x-2';
                  slot.innerHTML = `
                    <select name="scheduleDays[]" class="p-2 border rounded-lg">
                      <option value="Lunes">Lunes</option>
                      <option value="Martes">Martes</option>
                      <option value="Miércoles">Miércoles</option>
                      <option value="Jueves">Jueves</option>
                      <option value="Viernes">Viernes</option>
                    </select>
                    <input type="text" name="scheduleTimes[]" class="p-2 border rounded-lg flex-1"
                           placeholder="Ej: 08:00-12:00"
                           pattern="^([0-1][0-9]|2[0-3]|00):[0-5][0-9]-([0-1][0-9]|2[0-3]|00):[0-5][0-9]$"
                           title="Formato HH:MM-HH:MM (00:00-23:59)" required>
                    <button type="button" class="remove-schedule bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">✕</button>
                  `;
                  container.appendChild(slot);
                });

                // Añadir previa
                document.getElementById('add-prerequisite').addEventListener('click', function() {
                  const container = document.getElementById('prerequisites-container');
                  const slot = document.createElement('div');
                  slot.className = 'prerequisite-slot flex space-x-2';
                  slot.innerHTML = `
                    <select name="prerequisites[]" class="p-2 border rounded-lg flex-1">
                      <option value="">Seleccione una materia</option>
                      <% if (subjects) { %>
                        <% subjects.forEach(s => { %>
                          <option value="<%= s._id %>"><%= s.name %></option>
                        <% }) %>
                      <% } %>
                    </select>
                    <select name="prerequisiteTypes[]" class="p-2 border rounded-lg">
                      <option value="exam">Examen</option>
                      <option value="course">Curso</option>
                    </select>
                    <button type="button" class="remove-prerequisite bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600">✕</button>
                  `;
                  container.appendChild(slot);
                });

                // Eliminar dinámico
                document.addEventListener('click', function(e) {
                  if (e.target.classList.contains('remove-schedule')) {
                    e.target.closest('.schedule-slot').remove();
                  }
                  if (e.target.classList.contains('remove-prerequisite')) {
                    e.target.closest('.prerequisite-slot').remove();
                  }
                });

                // Validación de horarios
                function validateSchedules(event) {
                  const scheduleSlots = document.querySelectorAll('.schedule-slot');
                  const schedules = [];

                  scheduleSlots.forEach(slot => {
                    const day = slot.querySelector('select[name="scheduleDays[]"]').value;
                    const time = slot.querySelector('input[name="scheduleTimes[]"]').value;
                    schedules.push({ day, time });
                  });

                  for (let i = 0; i < schedules.length; i++) {
                    for (let j = i + 1; j < schedules.length; j++) {
                      if (schedules[i].day === schedules[j].day) {
                        const [start1, end1] = schedules[i].time.split('-');
                        const [start2, end2] = schedules[j].time.split('-');
                        if (isTimeOverlap(start1, end1, start2, end2)) {
                          alert('No se pueden superponer horarios en el mismo día.');
                          event.preventDefault();
                          return false;
                        }
                      }
                    }
                  }
                  return true;
                }

                function isTimeOverlap(start1, end1, start2, end2) {
                  const [h1, m1] = start1.split(':').map(Number);
                  const [h2, m2] = end1.split(':').map(Number);
                  const [h3, m3] = start2.split(':').map(Number);
                  const [h4, m4] = end2.split(':').map(Number);

                  const s1 = h1 * 60 + m1;
                  const e1 = h2 * 60 + m2;
                  const s2 = h3 * 60 + m3;
                  const e2 = h4 * 60 + m4;

                  return (s1 < e2 && s2 < e1);
                }
              </script>
            </body>
            </html>
